<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Best-effort: avoid browsers caching this HTML (so users get latest deploy without Ctrl+R) -->
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- GitHub Pages cache-buster: if a newer deploy exists, reload this HTML with ?v=... -->
    <script>
      (() => {
        try {
          const host = String(location.hostname || '').toLowerCase()
          const isGitHubPages = host.endsWith('github.io')
          if (!isGitHubPages) return

          const LOCAL_VERSION = '%APP_VERSION%'

          // If we're already on the latest build, remove the cache-buster param from the URL.
          try {
            const params = new URLSearchParams(location.search)
            const v = params.get('v') || ''
            if (v && v === LOCAL_VERSION) {
              params.delete('v')
              const next = new URL(location.href)
              next.search = params.toString() ? `?${params.toString()}` : ''
              history.replaceState(null, '', next.toString())
            }
          } catch {}

          const parseSemver = (v) => {
            const s = String(v || '').trim().replace(/^v/i, '')
            const core = s.split('-')[0]
            const [a, b, c] = core.split('.')
            return [Number(a) || 0, Number(b) || 0, Number(c) || 0]
          }

          const isNewer = (remote, local) => {
            const r = parseSemver(remote)
            const l = parseSemver(local)
            for (let i = 0; i < 3; i++) {
              if (r[i] > l[i]) return true
              if (r[i] < l[i]) return false
            }
            return false
          }

          const fetchVersion = async () => {
            const u = new URL('current_version.json', location.href)
            // If we already have a cache-bust query param, don't let it affect the JSON request.
            u.search = ''
            const res = await fetch(u.toString(), { cache: 'no-store' })
            if (!res.ok) return null
            return await res.json()
          }

          fetchVersion().then(async (remote) => {
            const remoteVersion = remote && remote.version ? String(remote.version) : ''
            if (!remoteVersion || !LOCAL_VERSION) return

            const currentV = new URLSearchParams(location.search).get('v') || ''
            if (currentV === remoteVersion) return

            if (!isNewer(remoteVersion, LOCAL_VERSION)) return

            const next = new URL(location.href)
            next.searchParams.set('v', remoteVersion)
            location.replace(next.toString())
          }).catch(() => {})
        } catch {}
      })()
    </script>
    <!-- Electron renderer security: avoid "no CSP / unsafe-eval" warnings -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        base-uri 'self';
        form-action 'self';
        object-src 'none';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: blob:;
        font-src 'self' data:;
        connect-src 'self' http: https: ws: wss:;
      "
    />
    <link rel="icon" href="./favicon.ico" />
    <title>GitLab Viz</title>
    <style>
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
